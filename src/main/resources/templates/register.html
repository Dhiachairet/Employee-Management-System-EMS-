<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Register - Employee Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .register-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .register-header {
            background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .register-body {
            padding: 40px;
        }
        .form-control {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        .form-control:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        .btn-register {
            background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
            border: none;
            padding: 12px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .btn-register:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(28, 200, 138, 0.4);
        }
        .alert {
            border-radius: 8px;
            padding: 12px 15px;
        }
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 3px;
            transition: all 0.3s;
        }
        .strength-weak { background-color: #dc3545; width: 25%; }
        .strength-medium { background-color: #ffc107; width: 50%; }
        .strength-strong { background-color: #28a745; width: 75%; }
        .strength-very-strong { background-color: #20c997; width: 100%; }
        .role-option {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        .role-option:hover {
            border-color: #1cc88a;
            background-color: rgba(28, 200, 138, 0.05);
        }
        .role-option.selected {
            border-color: #1cc88a;
            background-color: rgba(28, 200, 138, 0.1);
        }
        .role-icon {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        .role-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="register-card">
                <!-- Header -->
                <div class="register-header">
                    <div class="login-logo">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h2>Create Account</h2>
                    <p class="mb-0 opacity-75">Join the Employee Management System</p>
                </div>

                <!-- Body -->
                <div class="register-body">
                    <!-- Error/Success Messages -->
                    <div id="message" class="alert d-none"></div>

                    <!-- Registration Form -->
                    <form id="registerForm">
                        <div class="row">
                            <!-- Email -->
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label fw-bold">
                                    <i class="fas fa-envelope me-2"></i>Email Address
                                </label>
                                <input type="email" class="form-control" id="email"
                                       placeholder="you@example.com" required>
                                <div class="form-text">This will be your login username</div>
                            </div>

                            <!-- Phone -->
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label fw-bold">
                                    <i class="fas fa-phone me-2"></i>Phone Number
                                </label>
                                <input type="tel" class="form-control" id="phone"
                                       placeholder="(123) 456-7890" required>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Password -->
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label fw-bold">
                                    <i class="fas fa-lock me-2"></i>Password
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password"
                                           placeholder="Create password" required
                                           oninput="checkPasswordStrength(this.value)">
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="togglePasswordVisibility('password')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="password-strength mt-2" id="passwordStrength"></div>
                                <div class="form-text">
                                    Minimum 8 characters with uppercase, lowercase, and numbers
                                </div>
                            </div>

                            <!-- Confirm Password -->
                            <div class="col-md-6 mb-3">
                                <label for="confirmPassword" class="form-label fw-bold">
                                    <i class="fas fa-lock me-2"></i>Confirm Password
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirmPassword"
                                           placeholder="Confirm password" required>
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="togglePasswordVisibility('confirmPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text" id="passwordMatch"></div>
                            </div>
                        </div>

                        <!-- Role Selection (Single Select) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-user-tag me-2"></i>Select Your Role
                            </label>
                            <div class="row">
                                <!-- Employee Role (Default) -->
                                <div class="col-md-6">
                                    <div class="role-option selected" onclick="selectRole('employee')" id="roleEmployee">
                                        <div class="role-icon text-primary">
                                            <i class="fas fa-user-tie"></i>
                                        </div>
                                        <h5>Employee</h5>
                                        <p class="small text-muted mb-2">
                                            Standard employee access. Can view and request leave.
                                        </p>
                                        <span class="badge bg-primary role-badge">Default</span>
                                    </div>
                                </div>

                                <!-- Manager Role -->
                                <div class="col-md-6">
                                    <div class="role-option" onclick="selectRole('manager')" id="roleManager">
                                        <div class="role-icon text-warning">
                                            <i class="fas fa-user-tie"></i>
                                        </div>
                                        <h5>Manager</h5>
                                        <p class="small text-muted mb-2">
                                            Can manage team members and approve leave requests.
                                        </p>
                                        <span class="badge bg-warning role-badge">Requires Approval</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden input for selected role -->
                            <input type="hidden" id="selectedRole" name="role" value="employee">

                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Employee role is selected by default. Manager role requires admin approval.
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="terms" required>
                                <label class="form-check-label" for="terms">
                                    I agree to the <a href="#" class="text-decoration-none">Terms of Service</a>
                                    and <a href="#" class="text-decoration-none">Privacy Policy</a>
                                </label>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                            <a href="/login" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back to Login
                            </a>
                            <button type="submit" class="btn btn-register text-white">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-4">
                <p class="text-white mb-1">
                    © 2024 Employee Management System
                </p>
                <p class="text-white opacity-75 small">
                    By registering, you agree to our terms and conditions
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // DOM Elements
    const registerForm = document.getElementById('registerForm');
    const messageDiv = document.getElementById('message');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const passwordMatchDiv = document.getElementById('passwordMatch');
    const selectedRoleInput = document.getElementById('selectedRole');

    // Role selection
    function selectRole(role) {
        // Remove selected class from all roles
        document.querySelectorAll('.role-option').forEach(el => {
            el.classList.remove('selected');
        });

        // Add selected class to clicked role
        const selectedElement = document.getElementById(`role${role.charAt(0).toUpperCase() + role.slice(1)}`);
        selectedElement.classList.add('selected');

        // Update hidden input
        selectedRoleInput.value = role;
    }

    // Password strength checker
    function checkPasswordStrength(password) {
        const strengthDiv = document.getElementById('passwordStrength');
        let strength = 0;

        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;

        strengthDiv.className = 'password-strength';

        if (password.length === 0) {
            strengthDiv.className = 'password-strength d-none';
            return;
        }

        if (strength < 2) {
            strengthDiv.className = 'password-strength strength-weak';
        } else if (strength < 3) {
            strengthDiv.className = 'password-strength strength-medium';
        } else if (strength < 4) {
            strengthDiv.className = 'password-strength strength-strong';
        } else {
            strengthDiv.className = 'password-strength strength-very-strong';
        }

        // Check password match
        checkPasswordMatch();
    }

    // Check if passwords match
    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (confirmPassword.length === 0) {
            passwordMatchDiv.textContent = '';
            return;
        }

        if (password === confirmPassword) {
            passwordMatchDiv.textContent = 'Passwords match ✓';
            passwordMatchDiv.className = 'form-text text-success';
        } else {
            passwordMatchDiv.textContent = 'Passwords do not match ✗';
            passwordMatchDiv.className = 'form-text text-danger';
        }
    }

    // Toggle password visibility
    function togglePasswordVisibility(fieldId) {
        const input = document.getElementById(fieldId);
        const button = input.parentNode.querySelector('button');

        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);

        const icon = button.querySelector('i');
        icon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
    }

    // Setup event listeners for password matching
    passwordInput.addEventListener('input', checkPasswordMatch);
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);

    // Handle form submission
    registerForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Get form data
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const role = selectedRoleInput.value;

        // Validate passwords match
        if (password !== confirmPassword) {
            showMessage('danger', 'Passwords do not match!');
            return;
        }

        // Show loading state
        const submitBtn = registerForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Account...';
        submitBtn.disabled = true;

        try {
            // Send registration request to REST API
            const response = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    password: password,
                    phone: phone,
                    roles: [role] // Send as array with single role
                })
            });

            const data = await response.json();

            if (response.ok) {
                // Registration successful
                showMessage('success', data.message || 'Registration successful!');

                // Auto-login after successful registration
                setTimeout(async () => {
                    try {
                        const loginResponse = await fetch('/api/auth/signin', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: email,
                                password: password
                            })
                        });

                        const loginData = await loginResponse.json();

                        if (loginResponse.ok) {
                            localStorage.setItem('token', loginData.token);
                            localStorage.setItem('user', JSON.stringify({
                                id: loginData.id,
                                email: loginData.email,
                                roles: loginData.roles
                            }));

                            document.cookie = `token=${loginData.token}; path=/; max-age=86400`;

                            window.location.href = '/dashboard';
                        } else {
                            // Login failed after registration
                            showMessage('warning', 'Account created! Please login manually.');
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }

                    } catch (loginError) {
                        showMessage('warning', 'Account created! Please login manually.');
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                }, 2000);

            } else {
                // Registration failed
                showMessage('danger', data.message || 'Registration failed. Please try again.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }

        } catch (error) {
            console.error('Registration error:', error);
            showMessage('danger', 'Network error. Please try again.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    // Show message function
    function showMessage(type, text) {
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = text;
        messageDiv.classList.remove('d-none');

        // Auto hide after 5 seconds (unless it's success)
        if (type !== 'success') {
            setTimeout(() => {
                messageDiv.classList.add('d-none');
            }, 5000);
        }
    }

    // Check if already logged in
    window.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        if (token) {
            window.location.href = '/dashboard';
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>